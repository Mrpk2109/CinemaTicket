var overpass=function(t){"use strict";const e="https://overpass-api.de/api/interpreter";var s=Object.freeze({__proto__:null,main:e,main1:"https://lz4.overpass-api.de/api/interpreter",main2:"https://z.overpass-api.de/api/interpreter",kumi:"https://overpass.kumi.systems/api/interpreter",kumi1:"https://bib.kumi.systems/api/interpreter",kumi2:"https://willard.kumi.systems/api/interpreter",kumi3:"https://dodonna.kumi.systems/api/interpreter",france:"https://overpass.openstreetmap.fr/api/interpreter",switzerland:"https://overpass.osm.ch/api/interpreter",russia:"https://overpass.openstreetmap.ru/api/interpreter",usmil:"https://osm-overpass.gs.mil/overpass/interpreter"});const r=t=>new Promise((e=>{setTimeout(e,t)})),i=t=>{console.log(`${new Date(Date.now()).toISOString()} Overpass: ${t}`)};class n extends Error{constructor(t){super(`Overpass Error: ${t}`)}}const a=(t,e={})=>{let s;if("string"==typeof t)s={query:t};else{if(!("query"in t))throw new Error("Query Object must have {query}");s=t}return s=Object.assign({},{name:null,output:"raw",options:{}},s,e),s},u={endpoint:e,verbose:!1,userAgent:"overpass-ts"},o=(t,e={})=>{const s=Object.assign({},u,e);s.verbose&&(i(`endpoint ${s.endpoint}`),i(`query ${t}`));const r={body:`data=${encodeURIComponent(t)}`,method:"POST",mode:"cors",redirect:"follow",headers:{Accept:"*","Cache-control":"no-cache",Pragma:"no-cache","User-Agent":s.userAgent}};return fetch(s.endpoint,r).then((async e=>{if(!e.ok)switch(e.status){case 400:const s=((t,e)=>{let s,r=[];for(;s=t.exec(e);)r.push(s[1]);return r})(/<\/strong>: ([^<]+) <\/p>/g,await e.text()).map((t=>t.replace(/&quot;/g,'"')));throw new d(t,s);case 429:throw new m;case 504:throw new y;default:throw new n(`${e.status} ${e.statusText}`)}var r;return s.verbose&&e.headers.has("content-length")&&i("response payload "+((r=parseInt(e.headers.get("content-length")))>1048576?Math.round(r/1048576*100)/100+"MiB":Math.round(r/1024*100)/100+"KiB")),e}))},p=(t,e={})=>o(t,e).then((t=>t.json())).then((t=>{if(t.remark)throw new v([t.remark]);return t})),h=(t,e={})=>o(t,e).then((t=>t.text())).then((t=>{if("</remark>"===t.slice(-18,-9)){const e=t.split("\n"),s=[];for(let t=e.length-4;t>0;t--){const r=e[t].match(/<remark>\s*(.+)\s*<\/remark>/);if(!r)break;s.push(r[1])}throw new v(s)}return t})),l=(t,e={})=>o(t,e).then((t=>t.text())),c=(t,e={})=>o(t,e).then((t=>t.body));class m extends n{apiStatus;constructor(t=null){super("429 Rate Limit Exceeded"),this.apiStatus=t}}class d extends n{errors;query;constructor(t,e){super(["400 Bad Request\n","Errors:\n  ",e.join("\n  "),"\n","Query:\n  ",t.replace(/\n/g,"\n  ")].join("")),this.errors=e,this.query=t}}class v extends n{errors;constructor(t){super(t.join("\n  ")),this.errors=t}}class y extends n{constructor(){super("504 Gateway Timeout")}}const g={verbose:!1},q=(t,e={})=>{const s=Object.assign({},g,e),r="string"==typeof t?new URL(t):t;return fetch(r.href.replace("/interpreter","/status")).then((t=>{const e=t.headers.get("content-type");if(!e||"text/plain"!==e.split(";")[0])throw new b(`Response type incorrect (${e})`);return t.text()})).then((t=>{const e=w(t);if(!("clientId"in e))throw new b("Unable to parse API Status");return s.verbose&&i([r.host,"status",[`(rl ${e.rateLimit}`,`sl ${e.slotsLimited.length}`,`sr ${e.slotsRunning.length})`].join(" ")].join(" ")),e}))},w=t=>{const e={slotsRunning:[],slotsLimited:[]};return t.split("\n").forEach((t=>{const s=t.split(" ")[0];"Connected"==s?e.clientId=t.slice(14):"Current"==s?e.currentTime=t.slice(14):"Rate"==s?e.rateLimit=parseInt(t.slice(12)):"Slot"==s?e.slotsLimited.push([t.slice(22).split(", ")].map((t=>({time:t[0],seconds:parseInt(t[1].split(" ")[1])})))[0]):"Currently"==s||t.includes("available")||""===t||e.slotsRunning.push([t.split("\t")].map((t=>({pid:parseInt(t[0]),spaceLimit:parseInt(t[1]),timeLimit:parseInt(t[2]),startTime:t[3]})))[0])})),e};class b extends n{constructor(t){super(`API Status error: ${t}`)}}const f={gatewayTimeoutPause:2e3,rateLimitPause:5e3,minRequestInterval:2e3,verbose:!1,maxSlots:4};class S{statusTimeout=null;status=null;statusAvailable=!0;opts;queue=[];queueIndex=0;queueRunning=0;uri;constructor(t,e={}){this.opts=Object.assign({},f,e),this.uri=new URL(t)}updateStatus(){return this.statusTimeout&&(clearTimeout(this.statusTimeout),this.statusTimeout=null),q(this.uri.href,{verbose:this.opts.verbose}).then((t=>{if(this.status=t,this.status.slotsLimited.length==this.getRateLimit()){const t=Math.min(...this.status.slotsLimited.map((t=>t.seconds)))+.1;this.opts.verbose&&this.status.slotsLimited.length==this.getRateLimit()&&i(`${this.uri.host} rate limited; waiting ${t}s`),this.statusTimeout=setTimeout((async()=>{await this.updateStatus()}),1e3*t)}})).catch((t=>{this.opts.verbose&&i(`${this.uri.host} ERROR getting api status (${t.message})`),this.statusAvailable=!1}))}async _query(t){const e=this.queue.push(t);return t.name||(t.name=(e-1).toString()),this.opts.verbose&&i(`${this.uri.host} query ${t.name} queued`),!this.status&&this.statusAvailable&&this.queue.length-1==this.queueIndex&&await this.updateStatus(),new Promise((s=>{const r=()=>{const i=this.getSlotsAvailable();e<=this.queueIndex+i?(this.queueIndex++,this.queueRunning++,setTimeout((()=>{s(this._sendQuery(t))}),(this.queueIndex+i-e-1)*this.opts.minRequestInterval)):setTimeout(r,100)};r()}))}query(t){return this._query(a(t,{output:"raw"}))}queryJson(t){return this._query(a(t,{output:"json"}))}queryXml(t){return this._query(a(t,{output:"xml"}))}queryCsv(t){return this._query(a(t,{output:"csv"}))}queryStream(t){return this._query(a(t,{output:"stream"}))}_sendQuery(t){let e;return this.opts.verbose&&i(`${this.uri.host} query ${t.name} sending`),e="json"==t.output?p:"xml"==t.output?h:"csv"==t.output?l:"stream"==t.output?c:o,e(t.query,{...t.options,endpoint:this.uri.href}).then((async e=>(this.opts.verbose&&i(`${this.uri.host} query ${t.name} complete`),this.queueRunning--,this.statusAvailable&&await this.updateStatus(),e))).catch((async e=>{if(e instanceof m)return this.opts.verbose&&i(`${this.uri.host} query ${t.name} rate limited`),new Promise((async e=>{const s=()=>{this.getSlotsAvailable()+1>0?e(this._sendQuery(t)):setTimeout(s,100)};this.statusAvailable?await this.updateStatus():await r(this.opts.rateLimitPause),s()}));if(e instanceof y)return this.opts.verbose&&i(`${this.uri.host} query ${t.name} gateway timeout`),r(this.opts.gatewayTimeoutPause).then((()=>this._sendQuery(t)));throw this.opts.verbose&&i(`${this.uri.host} query ${t.name} uncaught error (${e.message})`),this.queueRunning--,!this.statusTimeout&&this.statusAvailable&&await this.updateStatus(),e}))}getRateLimit(){return this.status?this.status.rateLimit>0?this.status.rateLimit:this.opts.maxSlots:this.statusAvailable?0:this.opts.maxSlots}getSlotsAvailable(){const t=this.getRateLimit();return this.status?t-this.queueRunning-this.status.slotsLimited.length:this.statusAvailable?0:t-this.queueRunning}}const $={endpoints:e,maxSlots:4,numRetries:1,retryPause:2e3,verbose:!1};return t.OverpassApiStatusError=b,t.OverpassBadRequestError=d,t.OverpassEndpoint=S,t.OverpassGatewayTimeoutError=y,t.OverpassManager=class{opts=$;endpoints=[];endpointsInitialized=!1;constructor(t={}){this.opts=Object.assign({},$,t),this.endpoints=[this.opts.endpoints].flat().map((t=>new S(t,{verbose:this.opts.verbose})))}async _query(t){return this.endpointsInitialized||(this.endpointsInitialized=!0,await Promise.all(this.endpoints.map((t=>t.updateStatus())))),new Promise((e=>{const s=()=>{const r=this._getAvailableEndpoint();r?e(r._query(t)):setTimeout(s,100)};s()}))}query(t){return this._query(a(t,{output:"raw"}))}queryJson(t){return this._query(a(t,{output:"json"}))}queryXml(t){return this._query(a(t,{output:"xml"}))}queryCsv(t){return this._query(a(t,{output:"csv"}))}queryStream(t){return this._query(a(t,{output:"stream"}))}_getAvailableEndpoint(){for(let t of this.endpoints)if(t.getSlotsAvailable()>0)return t;return null}},t.OverpassRateLimitError=m,t.OverpassRuntimeError=v,t.apiStatus=q,t.defaultApiStatusOptions=g,t.defaultOverpassOptions=u,t.endpoints=s,t.overpass=o,t.overpassCsv=l,t.overpassJson=p,t.overpassStream=c,t.overpassXml=h,t.parseApiStatus=w,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
